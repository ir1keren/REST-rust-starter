name: CI

on:
  push:
    branches: [ main, openapi, ci-docker ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --verbose

      - name: Check build
        run: cargo build --verbose --release

  build-container:
    name: Build Container
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/ci-docker'
    strategy:
      matrix:
        container-engine: [podman, docker]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Podman
        if: matrix.container-engine == 'podman'
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Set up Docker
        if: matrix.container-engine == 'docker'
        uses: docker/setup-buildx-action@v3

      - name: Build image with Podman
        if: matrix.container-engine == 'podman'
        run: |
          podman build -t rust-mvc-api:latest -f Podmanfile .

      - name: Build image with Docker
        if: matrix.container-engine == 'docker'
        run: |
          docker build -t rust-mvc-api:latest -f Dockerfile .

      - name: Test container with Podman
        if: matrix.container-engine == 'podman'
        run: |
          # Run container in background
          podman run -d --name test-api -p 8080:8080 rust-mvc-api:latest
          
          # Wait for container to start
          sleep 10
          
          # Test health endpoint
          curl -f http://localhost:8080/health || exit 1
          
          # Test API endpoints
          curl -f http://localhost:8080/api/v1/projects || exit 1
          
          # Cleanup
          podman stop test-api
          podman rm test-api

      - name: Test container with Docker
        if: matrix.container-engine == 'docker'
        run: |
          # Run container in background
          docker run -d --name test-api -p 8080:8080 rust-mvc-api:latest
          
          # Wait for container to start
          sleep 10
          
          # Test health endpoint
          curl -f http://localhost:8080/health || exit 1
          
          # Test API endpoints
          curl -f http://localhost:8080/api/v1/projects || exit 1
          
          # Cleanup
          docker stop test-api
          docker rm test-api

      - name: Save image with Podman
        if: matrix.container-engine == 'podman'
        run: |
          podman save rust-mvc-api:latest | gzip > rust-mvc-api-podman.tar.gz

      - name: Save image with Docker
        if: matrix.container-engine == 'docker'
        run: |
          docker save rust-mvc-api:latest | gzip > rust-mvc-api-docker.tar.gz
          
      - name: Upload container artifact
        uses: actions/upload-artifact@v4
        with:
          name: container-image-${{ matrix.container-engine }}
          path: rust-mvc-api-${{ matrix.container-engine }}.tar.gz
          retention-days: 7